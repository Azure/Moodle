{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "moodleCommon": {
            "metadata": {
                "description": "Common Moodle values"
            },
            "type": "object"
        },
        "subnetIdAppGw": {
            "metadata": {
                "description": "Azure resource ID of the subnet where this App Gw should be deployed"
            },
            "type": "string"
        },
        "sslCertData": {
            "metadata": {
                "description": "Base64-encoded PFX (no password protected) file content for the SSL cert to be used on the App Gateway for SSL termination. Should be passed from an Azure Key Vault."
            },
            "type": "securestring"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Network/applicationGateways",
            "name": "[parameters('moodleCommon').appGwName]",
            "location": "[parameters('moodleCommon').location]",
            "apiVersion": "2018-02-01",
            "properties": {
                "sku": {
                    "name": "[parameters('moodleCommon').appGwSkuName]",
                    "tier": "[parameters('moodleCommon').appGwSkuTier]",
                    "capacity": "[parameters('moodleCommon').appGwSkuCapacity]"
                },
                "gatewayIPConfigurations": [
                    {
                        "name": "appGwIpConfig",
                        "properties": {
                            "subnet": {
                                "id": "[parameters('subnetIdAppGw')]"
                            }
                        }
                    }
                ],
                "frontendIPConfigurations": [
                    {
                        "name": "appGwFrontendIP",
                        "properties": {
                            "publicIPAddress": {
                                "id": "[variables('appGwPublicIPAddressID')]"
                            }
                        }
                    }
                ],
                "frontendPorts": [
                    {
                        "name": "httpsFrontendPort",
                        "properties": {
                            "port": 443
                        }
                    },
                    {
                        "name": "httpFrontendPort",
                        "properties": {
                            "port": 80
                        }
                    }                    
                ],
                "backendAddressPools": [
                    {
                        "name": "[variables('appGwBePoolName')]"
                    }
                ],
                "backendHttpSettingsCollection": [
                    {
                        "name": "appGwBackendHttpSettings",
                        "properties": {
                            "port": 80,
                            "protocol": "Http",
                            "cookieBasedAffinity": "Disabled"
                        }
                    }
                ],
                "sslCertificates": [
                     {
                        "name": "appGatewaySslCert",
                        "properties": {
                            "data": "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"
                        }
                    }
                "httpListeners": [
                    {
                        "name": "appGwHttpsListener",
                        "properties": {
                            "frontendIPConfiguration": {
                                "Id": "[concat(variables('appGwID'), '/frontendIPConfigurations/appGwFrontendIP')]"
                            },
                            "frontendPort": {
                                "Id": "[concat(variables('appGwID'), '/frontendPorts/httpsFrontendPort')]"
                            },
                            "protocol": "Https",
                            "sslCertificate": {
                                "Id": "[concat(variables('appGwID'), '/sslCertificates/appGatewaySslCert')]"
                            }
                        }
                    },
                    {
                        "name": "appGwHttpListener",
                        "properties": {
                            "frontendIPConfiguration": {
                                "Id": "[concat(variables('appGwID'), '/frontendIPConfigurations/appGwFrontendIP')]"
                            },
                            "frontendPort": {
                                "Id": "[concat(variables('appGwID'), '/frontendPorts/httpFrontendPort')]"
                            },
                            "protocol": "Http"
                        }
                    }
                ],
                "redirectConfigurations": [
                    {
                        "name": "httpToHttps",
                        "properties": {
                            "redirectType":"Permanent",
                            "includePath" : true,
                            "includeQueryString" : true,
                            "targetListener": {
                                "id": "[concat(variables('appGwID'), '/httpListeners/appGwHttpsListener')]"
                            }
                        }
                    }
                ],                
                "requestRoutingRules": [
                    {
                        "Name": "httpsRule",
                        "properties": {
                            "ruleType": "Basic",
                            "httpListener": {
                                "id": "[concat(variables('appGwID'), '/httpListeners/appGwHttpsListener')]"
                            },
                            "backendAddressPool": {
                                "id": "[concat(variables('appGwID'), '/backendAddressPools/', variables('appGwBePoolName'))]"
                            },
                            "backendHttpSettings": {
                                "id": "[concat(variables('appGwID'), '/backendHttpSettingsCollection/appGwBackendHttpSettings')]"
                            }
                        }
                    },
                    {
                        "Name": "httpRedirectRule",
                        "properties": {
                            "ruleType": "Basic",
                            "httpListener": {
                                "id": "[concat(variables('appGwID'), '/httpListeners/appGwHttpListener')]"
                            },
                            "redirectConfiguration": {
                                "id": "[concat(variables('appGwID'), '/redirectConfigurations/httpToHttps')]"
                            }
                        }
                    }
                ]
            }
        }
    ],
    "variables": {
        "documentation1": "This sub-template creates an Azure Application Gateway for SSL offloading. It expects certain values in the 'common' datastructure.",
        "appGwBePoolName": "[parameters('moodleCommon').appGwBePoolName]",
        "appGwPublicIPAddressID": "[resourceId('Microsoft.Network/publicIPAddresses',parameters('moodleCommon').appGwPipName)]",
        "appGwID": "[resourceId('Microsoft.Network/applicationGateways', parameters('moodleCommon').appGwName)]"
    }
}
